rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // TestFlight requests - Allow public write for download app page
    match /testflight_requests/{requestId} {
      allow create: if true; // Anyone can submit a TestFlight request
      allow read, update, delete: if request.auth != null; // Only authenticated users (admins) can read/update
    }
    
    // Opportunity Stage History - Read-only for admins, write only by backend
    match /opportunityStageHistory/{historyId} {
      allow read: if request.auth != null && 
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      allow write: if false; // Only backend/Cloud Functions can write
    }
    
    // Products - Admin only access for performance cost tracking
    match /products/{productId} {
      allow read, write: if request.auth != null && isAdmin();
    }
    
    // Ad Performance Costs - Admin only access for budget and profit tracking
    match /adPerformanceCosts/{costId} {
      allow read, write: if request.auth != null && isAdmin();
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Google Calendar Tokens - Only practitioner can access their own tokens
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // Ensure Google Calendar tokens are only accessible to the token owner
      allow read: if request.auth != null && request.auth.uid == userId &&
        !('googleRefreshToken' in resource.data) || request.auth.uid == userId;
      
      // Prevent reading other users' Google tokens
      allow update: if request.auth != null && request.auth.uid == userId &&
        (!('googleRefreshToken' in request.resource.data) || 
         request.auth.uid == userId);
    }
    
    // Appointments - Can include sync status and Google event ID
    match /appointments/{appointmentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && 
        (resource.data.practitionerId == request.auth.uid || isAdmin());
      allow delete: if request.auth != null && 
        (resource.data.practitionerId == request.auth.uid || isAdmin());
    }
    
    // SUPER PERMISSIVE RULES - Allow all authenticated users to do everything
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}